agent {
    {{- if eq .VmMode "docker" }}
    data_dir = "/opt/spire-data"
    {{- else if eq .VmMode "systemd" }}
    data_dir = "/opt/spire-agent/spire-data"
    {{- end }}
    log_level = "DEBUG"
    trust_domain = "accuknox.com"
    join_token = "{{.JoinToken}}"
    insecure_bootstrap = true

    # spire-server address
    server_address = "{{.SpireHostAddr}}"
    server_port = "{{.SpireHostPort}}"
    #trust_bundle_url = "{{.SpireTrustBundleURL}}"

    {{- if eq .VmMode "docker" }}
    # exposing spire-agent
    agent_address = "0.0.0.0"
    agent_port = "9091"
    {{- end }}
    socket_path ="/var/run/spire/agent.sock"
}

plugins {
    NodeAttestor "join_token" {
        plugin_data {
        }
    }
    KeyManager "disk" {
        plugin_data {
            {{- if eq .VmMode "docker" }}
            directory = "/opt/spire-data"
            {{- else if eq .VmMode "systemd" }}
            directory = "/opt/spire-agent/spire-data"
            {{- end }}
        }
    }
    {{- if eq .VmMode "systemd" }}
    WorkloadAttestor "systemd" {
    }
    {{- else if eq .VmMode "docker" }}
    WorkloadAttestor "docker" {
        plugin_data {
            container_id_cgroup_matchers = []
        }   
    }
    {{- end }}
}

health_checks {
  listener_enabled = true
  bind_address = "0.0.0.0"
  bind_port = "9090"
  live_path = "/live"
  ready_path = "/ready"
}
